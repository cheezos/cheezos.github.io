<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local AI Interface</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        :root {
            --background-color: #1a1a1a; --text-color: #e0e0e0; --primary-color: #007bff;
            --secondary-color: #2b2b2b; --tertiary-color: #3c3c3c; --border-color: #4a4a4a;
            --accent-color: #ff4d4d; --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --border-radius: 8px; --padding: 16px;
        }

        * { box-sizing: border-box; }

        body {
            font-family: var(--font-family); background-color: var(--background-color); color: var(--text-color);
            margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh;
        }

        #app-container {
            width: 100%; max-width: 800px; height: 90vh; background-color: var(--secondary-color);
            border-radius: var(--border-radius); display: flex; flex-direction: column;
            overflow: hidden; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); position: relative;
        }

        #chat-container {
            flex-grow: 1; padding: var(--padding); overflow-y: auto;
            display: flex; flex-direction: column; gap: 1.5rem;
        }

        .message { display: flex; gap: 0.8rem; max-width: 95%; flex-direction: column; animation: fadeIn 0.3s ease-in-out; }
        .user-message { align-self: flex-end; align-items: flex-end; }
        .ai-message { align-self: flex-start; align-items: flex-start; }
        
        .message-main { display: flex; gap: 0.8rem; width: 100%; }
        .user-message .message-main { flex-direction: row-reverse; }

        .avatar {
            width: 40px; height: 40px; border-radius: 50%; background-color: var(--primary-color);
            display: flex; justify-content: center; align-items: center; font-weight: bold; flex-shrink: 0;
        }
        .user-message .avatar { background-color: var(--accent-color); }

        .message-bubbles { display: flex; flex-direction: column; gap: 0.5rem; min-width: 0; flex-grow: 1; }
        .message-content { background-color: var(--tertiary-color); padding: 0.8rem 1.2rem; border-radius: var(--border-radius); white-space: pre-wrap; overflow-wrap: break-word; }

        .code-block-container { background-color: #282c34; border-radius: var(--border-radius); margin: 0.5rem 0; overflow: hidden; }
        .code-block-header {
            display: flex; justify-content: space-between; align-items: center; background-color: #21252b;
            padding: 0.5rem 1rem; color: #abb2bf; font-size: 0.9em;
        }
        .code-block-language { text-transform: uppercase; }
        .code-block-copy-button { background: none; border: none; color: #abb2bf; cursor: pointer; padding: 0.25rem; display: flex; align-items: center; }
        .code-block-copy-button:hover { color: #fff; }
        .code-block-copy-button svg { width: 16px; height: 16px; fill: currentColor; }
        .code-block-container pre { margin: 0; }
        .code-block-container pre code.hljs { padding: 1rem; border-radius: 0 0 var(--border-radius) var(--border-radius); overflow-wrap: normal; white-space: pre; }
        
        .info-message {
            align-self: center; max-width: 95%; width: 100%; background-color: var(--tertiary-color);
            border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 1rem 1.5rem;
            color: #ccc; font-size: 0.95em; overflow-wrap: break-word; animation: fadeIn 0.3s ease-in-out;
        }
        .info-message h3 { margin-top: 0; color: var(--text-color); }
        .info-message p { line-height: 1.6; }
        .info-message a { color: var(--primary-color); text-decoration: none; }
        .info-message a:hover { text-decoration: underline; }
        .info-message code { background-color: rgba(0, 0, 0, 0.3); padding: 0.2em 0.4em; border-radius: 4px; font-family: 'Courier New', Courier, monospace; overflow-wrap: break-word; }
        .info-message pre { background-color: #161616; padding: 1em; border-radius: var(--border-radius); white-space: pre-wrap; overflow-wrap: break-word; }

        .thinking-container { display: none; }
        .toggle-thinking-button {
            background: none; border: 1px solid var(--border-color); color: var(--text-color); padding: 0.25rem 0.75rem;
            border-radius: 1rem; cursor: pointer; font-size: 0.8rem; align-self: flex-start; margin-bottom: 0.25rem;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .toggle-thinking-button:hover:not(.thinking-active) { background-color: var(--border-color); }
        .thinking-content {
            display: none; background-color: rgba(0, 0, 0, 0.2); border: 1px dashed var(--border-color);
            padding: 0.8rem 1.2rem; border-radius: var(--border-radius); white-space: pre-wrap;
            overflow-wrap: break-word; font-style: italic; color: #c0c0c0;
        }
        .thinking-container.expanded .thinking-content { display: block; }
        
        .loading-model-indicator { color: #b0b0b0; font-style: italic; animation: pulse 2s infinite ease-in-out; }
        @keyframes pulse { 0% { opacity: 0.7; } 50% { opacity: 1; } 100% { opacity: 0.7; } }
        .thinking-active { animation: pulse-border 1.5s infinite ease-in-out; }
        @keyframes pulse-border { 0% { border-color: var(--border-color); } 50% { border-color: var(--primary-color); } 100% { border-color: var(--border-color); } }
        .typing-cursor {
            display: inline-block; width: 8px; height: 1em; background-color: var(--text-color);
            border-radius: 1px; animation: blink 1s infinite; margin-left: 4px; vertical-align: text-bottom;
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .bubble-actions { display: flex; gap: 8px; margin-top: 8px; padding: 0 48px; opacity: 0; transition: opacity 0.2s ease-in-out; pointer-events: none; }
        .user-message .bubble-actions { justify-content: flex-end; }
        .message:hover .bubble-actions { opacity: 1; pointer-events: all; }
        .action-button { background: var(--tertiary-color); border: 1px solid var(--border-color); color: #ccc; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s; }
        .action-button:hover { background-color: #4a4a4a; }
        .action-button svg { width: 16px; height: 16px; fill: currentColor; }
        
        #prompt-ui-container { display: flex; flex-direction: column; border-top: 1px solid var(--border-color); background-color: var(--secondary-color); }
        #input-form { display: flex; padding: var(--padding); }
        #prompt-input { flex-grow: 1; background-color: var(--tertiary-color); border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 0.8rem 1.2rem; color: var(--text-color); font-size: 1rem; outline: none; transition: border-color 0.3s; }
        #prompt-input:focus { border-color: var(--primary-color); }
        #submit-button { background-color: var(--primary-color); color: white; border: none; padding: 0.8rem 1.5rem; margin-left: 0.8rem; border-radius: var(--border-radius); cursor: pointer; font-size: 1rem; transition: background-color 0.3s; }
        #submit-button:hover:not(:disabled) { background-color: #0056b3; }
        #submit-button:disabled { background-color: #555; cursor: not-allowed; }

        #drop-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; font-size: 2em; color: white; border: 2px dashed var(--primary-color); pointer-events: none; opacity: 0; transition: opacity 0.2s ease-in-out; z-index: 10; }
        #app-container.drag-over #drop-overlay { opacity: 1; }

        #file-context-bar { padding: 8px var(--padding) 0 var(--padding); display: flex; flex-wrap: wrap; gap: 8px; }
        .file-pill { display: flex; align-items: center; background-color: var(--tertiary-color); border: 1px solid var(--border-color); border-radius: 1rem; padding: 4px 8px; font-size: 0.85em; }
        .file-pill-name { max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-pill-remove { background: none; border: none; color: #aaa; cursor: pointer; margin-left: 8px; padding: 0; line-height: 1; font-size: 1.2em; }
        .file-pill-remove:hover { color: white; }
        
        .file-context-display { font-size: 0.85em; color: #ccc; background-color: rgba(0,0,0,0.2); padding: 0.5rem 1rem; border-radius: var(--border-radius); margin-bottom: 0.5rem; border: 1px dashed var(--border-color); }
    </style>

    <script type="importmap">
    { "imports": { "ollama": "https://cdn.jsdelivr.net/npm/ollama/dist/browser.mjs", "whatwg-fetch": "https://cdn.jsdelivr.net/npm/whatwg-fetch@3.6.2/fetch.js" } }
    </script>
</head>
<body>
    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
        <symbol id="icon-copy" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></symbol>
        <symbol id="icon-download" viewBox="0 0 24 24"><path d="M5 20h14v-2H5v2zM19 9h-4V3H9v6H5l7 7 7-7z"></path></symbol>
        <symbol id="icon-copied" viewBox="0 0 24 24"><path d="M9 16.17 4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"></path></symbol>
    </svg>

    <div id="app-container">
        <div id="drop-overlay">Drop Files Here</div>
        <div id="chat-container"></div>
        <div id="prompt-ui-container">
            <div id="file-context-bar"></div>
            <form id="input-form">
                <input type="text" id="prompt-input" placeholder="Connecting to Ollama..." autocomplete="off">
                <button type="submit" id="submit-button">Send</button>
            </form>
        </div>
    </div>

    <script type="module">
        import ollama from 'ollama';

        const DOM = { appContainer: document.getElementById('app-container'), chatContainer: document.getElementById('chat-container'), inputForm: document.getElementById('input-form'), promptInput: document.getElementById('prompt-input'), submitButton: document.getElementById('submit-button'), fileContextBar: document.getElementById('file-context-bar') };
        const ICONS = { copy: `<svg><use xlink:href="#icon-copy"></use></svg>`, download: `<svg><use xlink:href="#icon-download"></use></svg>`, copied: `<svg><use xlink:href="#icon-copied"></use></svg>`, };
        const state = { isProcessing: false, isFirstPrompt: true, fileContexts: [] };

        async function main() {
            setProcessingState(true);
            const isOllamaRunning = await checkOllamaConnection();
            if (isOllamaRunning) { displayWelcomeMessage(); DOM.promptInput.placeholder = 'Ask a question or drop files...'; setProcessingState(false); } 
            else { const platform = getPlatform(); displaySetupInstructions(platform); DOM.promptInput.placeholder = 'Ollama not found. Please follow the instructions.'; }
            DOM.inputForm.addEventListener('submit', handleFormSubmit);
            setupDragAndDrop();
        }

        async function checkOllamaConnection() {
            try { await ollama.list(); return true; } 
            catch (err) { console.error("Ollama connection check failed:", err); return false; }
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            const promptText = DOM.promptInput.value.trim();
            const files = [...state.fileContexts];
            if ((!promptText && files.length === 0) || state.isProcessing) return;
            setProcessingState(true);
            DOM.promptInput.value = '';
            state.fileContexts = [];
            renderFileContextUI();
            const fullUserPrompt = generateFullUserPrompt(promptText, files);
            appendUserMessage(fullUserPrompt, files);
            await processPrompt(fullUserPrompt, files);
            state.isFirstPrompt = false;
        }

        async function processPrompt(fullPrompt, files) {
            const aiElements = createAiMessageShell();
            
            // NEW: Set initial feedback based on context
            let initialMessage = '';
            if (files.length > 0) {
                initialMessage = 'Reading files...';
            } else if (state.isFirstPrompt) {
                initialMessage = 'Loading model...';
            }
            if (initialMessage) {
                updateAiDom('text', initialMessage, aiElements);
                if (aiElements.currentTextElement) {
                    aiElements.currentTextElement.classList.add('loading-model-indicator');
                }
            }

            let buffer = '', fullResponseMarkdown = '';
            let parserState = 'default', codeLang = '';
            let initialMessageCleared = !initialMessage;
            
            try {
                const images = files.filter(f => f.type === 'image').map(f => f.content);
                const systemPrompt = { role: 'system', content: 'You are a helpful AI assistant. You must always respond in English. Your thinking process, enclosed in `<think>` tags, must also be in English. Format all code blocks with Markdown triple backticks, specifying the language. When files are provided, you must acknowledge them and use their content to answer the user\'s prompt.' };
                const userPrompt = { role: 'user', content: fullPrompt, images: images };
                const responseStream = await ollama.chat({ model: 'deepseek-r1:8b', messages: [systemPrompt, userPrompt], stream: true });

                for await (const chunk of responseStream) {
                    if (chunk.done) { if (chunk.error) throw new Error(chunk.error); break; }
                    
                    if (!initialMessageCleared) {
                        if(aiElements.currentTextElement) {
                            aiElements.currentTextElement.remove();
                            aiElements.currentTextElement = null;
                        }
                        initialMessageCleared = true;
                    }
                    
                    buffer += chunk.message.content;
                    
                    while (buffer.length > 0) {
                        if (parserState === 'default') {
                            const thinkMatch = buffer.indexOf('<think>');
                            const codeMatch = buffer.indexOf('```');
                            let firstMatchIndex = -1; let token = '';

                            if (thinkMatch !== -1 && (codeMatch === -1 || thinkMatch < codeMatch)) {
                                firstMatchIndex = thinkMatch; token = '<think>';
                            } else if (codeMatch !== -1) {
                                firstMatchIndex = codeMatch; token = '```';
                            }

                            if (firstMatchIndex !== -1) {
                                const textBefore = buffer.substring(0, firstMatchIndex);
                                updateAiDom('text', textBefore, aiElements);
                                fullResponseMarkdown += textBefore;
                                buffer = buffer.substring(firstMatchIndex);

                                if (token === '<think>') {
                                    parserState = 'in_think'; buffer = buffer.substring(7);
                                } else {
                                    const langMatch = buffer.match(/^```(\w*)\n?/);
                                    codeLang = langMatch ? langMatch : '';
                                    fullResponseMarkdown += `\`\`\`${codeLang}\n`;
                                    parserState = 'in_code';
                                    buffer = buffer.substring(langMatch ? langMatch.length : 3);
                                }
                            } else {
                                updateAiDom('text', buffer, aiElements); fullResponseMarkdown += buffer; buffer = '';
                            }
                        } else if (parserState === 'in_think') {
                            const endMatch = buffer.indexOf('</think>');
                            if (endMatch !== -1) {
                                const text = buffer.substring(0, endMatch);
                                updateAiDom('thinking', text, aiElements);
                                buffer = buffer.substring(endMatch + 8);
                                parserState = 'default';
                            } else {
                                updateAiDom('thinking', buffer, aiElements); buffer = '';
                            }
                        } else if (parserState === 'in_code') {
                            const endMatch = buffer.indexOf('```');
                            if (endMatch !== -1) {
                                const code = buffer.substring(0, endMatch);
                                updateAiDom('code_chunk', code, aiElements, codeLang);
                                fullResponseMarkdown += code + '```\n';
                                updateAiDom('code_end', '', aiElements);
                                buffer = buffer.substring(endMatch + 3);
                                parserState = 'default';
                            } else {
                                updateAiDom('code_chunk', buffer, aiElements, codeLang);
                                fullResponseMarkdown += buffer; buffer = '';
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Ollama communication error:', error);
                if (aiElements.currentTextElement?.classList.contains('loading-model-indicator')) aiElements.currentTextElement.remove();
                const errorMessage = error.message.includes('not found') ? `Error: Model "deepseek-r1:8b" not found. Pull it with: \`ollama pull deepseek-r1:8b\`` : 'Error: Could not connect to Ollama. Ensure it is running.';
                updateAiDom('text', errorMessage, aiElements);
            } finally {
                if (aiElements.toggleButton.textContent === 'Thinking...') aiElements.toggleButton.textContent = 'View Thought Process';
                aiElements.toggleButton.classList.remove('thinking-active');
                if (aiElements.cursor) aiElements.cursor.remove();
                addBubbleActions(aiElements.actionsContainer, () => fullResponseMarkdown.trim(), "ai-response.txt");
                setProcessingState(false);
                DOM.promptInput.focus();
            }
        }
        
        function setProcessingState(isProcessing) { state.isProcessing = isProcessing; DOM.promptInput.disabled = isProcessing; DOM.submitButton.disabled = isProcessing; }
        
        function updateAiDom(type, content, elements, lang = '') {
            if (!content && type !== 'code_end') return;
            const stopThinking = () => { if (elements.toggleButton.classList.contains('thinking-active')) { elements.toggleButton.textContent = 'View Thought Process'; elements.toggleButton.classList.remove('thinking-active'); } };
            switch(type) {
                case 'thinking':
                    elements.thinkingContainer.style.display = 'block'; elements.thinkingContent.textContent += content;
                    if (!elements.toggleButton.classList.contains('thinking-active')) { elements.toggleButton.textContent = 'Thinking...'; elements.toggleButton.classList.add('thinking-active'); }
                    break;
                case 'text':
                    stopThinking();
                    if (!elements.currentTextElement) {
                        elements.currentCodeElement = null;
                        elements.currentTextElement = document.createElement('div');
                        elements.currentTextElement.className = 'message-content';
                        elements.bubblesContainer.appendChild(elements.currentTextElement);
                    }
                    if (elements.cursor) elements.cursor.remove();
                    if (elements.currentTextElement.textContent === '') {
                        elements.currentTextElement.textContent += content.trimStart();
                    } else {
                        elements.currentTextElement.textContent += content;
                    }
                    elements.cursor = document.createElement('span');
                    elements.cursor.className = 'typing-cursor';
                    elements.currentTextElement.appendChild(elements.cursor);
                    break;
                case 'code_chunk':
                    stopThinking();
                    if (!elements.currentCodeElement) {
                        elements.currentTextElement = null; const container = document.createElement('div'); container.className = 'code-block-container';
                        container.innerHTML = `<div class="code-block-header"><span class="code-block-language">${lang || 'Code'}</span><button class="code-block-copy-button" title="Copy code"></button></div><pre><code class="hljs ${lang ? `language-${lang}` : ''}"></code></pre>`;
                        elements.bubblesContainer.appendChild(container); elements.currentCodeElement = container.querySelector('code');
                        const copyBtn = container.querySelector('.code-block-copy-button'); copyBtn.innerHTML = ICONS.copy;
                        copyBtn.addEventListener('click', () => { navigator.clipboard.writeText(elements.currentCodeElement.textContent).then(() => { copyBtn.innerHTML = ICONS.copied; setTimeout(() => { copyBtn.innerHTML = ICONS.copy; }, 1500); }); });
                    }
                    elements.currentCodeElement.textContent += content;
                    break;
                case 'code_end':
                    if (elements.currentCodeElement) { hljs.highlightElement(elements.currentCodeElement); elements.currentCodeElement = null; }
                    break;
            }
            DOM.chatContainer.scrollTop = DOM.chatContainer.scrollHeight;
        }

        function appendUserMessage(fullPrompt, files) {
            const messageElement = document.createElement('div'); messageElement.className = 'message user-message';
            const promptParts = fullPrompt.split('\n\n---\n\n');
            const promptTextOnly = promptParts[promptParts.length - 1]; 
            const sanitizedContent = promptTextOnly.replace(/</g, "<").replace(/>/g, ">");
            let fileHTML = '';
            if (files && files.length > 0) { fileHTML = `<div class="file-context-display"><strong>Context:</strong> ${files.map(f => f.name).join(', ')}</div>`; }
            messageElement.innerHTML = `<div class="message-main"><div class="avatar">U</div><div class="message-bubbles">${fileHTML}<div class="message-content">${sanitizedContent || '<i>(Sent with file context)</i>'}</div></div></div><div class="bubble-actions"></div>`;
            DOM.chatContainer.appendChild(messageElement);
            addBubbleActions(messageElement.querySelector('.bubble-actions'), () => fullPrompt, 'user-prompt.txt');
            DOM.chatContainer.scrollTop = DOM.chatContainer.scrollHeight;
        }

        function createAiMessageShell() {
            const messageElement = document.createElement('div'); messageElement.className = 'message ai-message';
            messageElement.innerHTML = `<div class="message-main"><div class="avatar">AI</div><div class="message-bubbles"><div class="thinking-container"><button class="toggle-thinking-button">View Thought Process</button><div class="thinking-content"></div></div></div></div><div class="bubble-actions"></div>`;
            DOM.chatContainer.appendChild(messageElement);
            const elements = {
                bubblesContainer: messageElement.querySelector('.message-bubbles'), thinkingContainer: messageElement.querySelector('.thinking-container'), toggleButton: messageElement.querySelector('.toggle-thinking-button'), thinkingContent: messageElement.querySelector('.thinking-content'), actionsContainer: messageElement.querySelector('.bubble-actions'), cursor: null, currentTextElement: null, currentCodeElement: null,
            };
            elements.toggleButton.addEventListener('click', () => { if (elements.toggleButton.classList.contains('thinking-active')) return; elements.thinkingContainer.classList.toggle('expanded'); elements.toggleButton.textContent = elements.thinkingContainer.classList.contains('expanded') ? 'Hide Thought Process' : 'View Thought Process'; });
            DOM.chatContainer.scrollTop = DOM.chatContainer.scrollHeight;
            return elements;
        }

        function addBubbleActions(container, textProvider, filename) {
            const copyButton = document.createElement('button'); copyButton.className = 'action-button'; copyButton.title = 'Copy'; copyButton.innerHTML = ICONS.copy;
            copyButton.addEventListener('click', () => { navigator.clipboard.writeText(textProvider()).then(() => { copyButton.innerHTML = ICONS.copied; setTimeout(() => { copyButton.innerHTML = ICONS.copy; }, 1500); }); });
            const downloadButton = document.createElement('button'); downloadButton.className = 'action-button'; downloadButton.title = 'Download'; downloadButton.innerHTML = ICONS.download;
            downloadButton.addEventListener('click', () => { const blob = new Blob([textProvider()], { type: 'text/plain' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); });
            container.append(copyButton, downloadButton);
        }

        function displayWelcomeMessage() {
            const welcomeBox = document.createElement('div'); welcomeBox.className = 'info-message';
            welcomeBox.innerHTML = `<h3>Ollama Connected</h3><p>Ready for your first prompt. What's on your mind?</p>`;
            DOM.chatContainer.appendChild(welcomeBox);
        }
        
        function displaySetupInstructions(platform) {
            const instructionBox = document.createElement('div'); instructionBox.className = 'info-message';
            const instructions = { Windows: `<p>Download and run the installer from the <a href="https://ollama.com/download" target="_blank">Ollama website</a>.</p>`, macOS: `<p>Download, unzip, and move the Ollama app to your Applications folder from the <a href="https://ollama.com/download" target="_blank">Ollama website</a>.</p>`, Linux: `<p>Install with this command:</p><pre><code>curl -fsSL https://ollama.com/install.sh | sh</code></pre>`, };
            instructionBox.innerHTML = `<h3>Connection to Ollama Failed</h3><p>This application requires the Ollama service to be running on your local machine. Please follow these steps:</p><p><strong>Step 1: Install Ollama for ${platform}</strong></p>${instructions[platform] || instructions.Linux}<p><strong>Step 2: Pull the Required Model</strong></p><p>After installing, open your terminal and run this command:</p><pre><code>ollama pull deepseek-r1:8b</code></pre><p><strong>Step 3: Refresh This Page</strong></p><p>Once the model has downloaded, simply refresh this page to connect.</p>`;
            DOM.chatContainer.appendChild(instructionBox);
        }

        function getPlatform() { const ua = navigator.userAgent; if (ua.includes("Win")) return "Windows"; if (ua.includes("Mac")) return "macOS"; if (ua.includes("Linux")) return "Linux"; return "Linux"; }
        
        function setupDragAndDrop() {
            const dropZone = DOM.appContainer;
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.add('drag-over'); });
            dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('drag-over'); });
            dropZone.addEventListener('drop', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('drag-over'); handleFileDrop(e.dataTransfer.files); });
        }

        function handleFileDrop(files) {
            for (const file of files) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result;
                    if (state.fileContexts.some(f => f.name === file.name)) return;
                    if (file.type.startsWith('image/')) { state.fileContexts.push({ name: file.name, type: 'image', content: content.split(',') }); } 
                    else if (file.type.startsWith('text/') || file.name.match(/\.(py|js|ts|md|html|css|json|txt)$/)) { state.fileContexts.push({ name: file.name, type: 'text', content: content }); }
                    renderFileContextUI();
                };
                reader.onerror = (e) => console.error(`Error reading file ${file.name}:`, e);
                if (file.type.startsWith('image/')) { reader.readAsDataURL(file); } 
                else if (file.type.startsWith('text/') || file.name.match(/\.(py|js|ts|md|html|css|json|txt)$/)) { reader.readAsText(file); }
            }
        }
        
        function generateFullUserPrompt(prompt, files) {
            const textFiles = files.filter(f => f.type === 'text');
            if (textFiles.length > 0) {
                const textContext = textFiles.map(f => `--- START FILE: ${f.name} ---\n${f.content}\n--- END FILE: ${f.name} ---`).join('\n\n');
                return `${textContext}\n\n---\n\n${prompt}`;
            }
            return prompt;
        }

        function renderFileContextUI() {
            DOM.fileContextBar.innerHTML = '';
            state.fileContexts.forEach((file, index) => {
                const pill = document.createElement('div'); pill.className = 'file-pill';
                pill.innerHTML = `<span class="file-pill-name" title="${file.name}">${file.name}</span>`;
                const removeBtn = document.createElement('button'); removeBtn.className = 'file-pill-remove';
                removeBtn.innerHTML = '×'; removeBtn.title = `Remove ${file.name}`;
                removeBtn.onclick = () => { state.fileContexts.splice(index, 1); renderFileContextUI(); };
                pill.appendChild(removeBtn);
                DOM.fileContextBar.appendChild(pill);
            });
        }

        main();

    </script>
</body>
</html>